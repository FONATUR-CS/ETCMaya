<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Campeche – Turismo Comunitario</title>

  <!-- Mapbox GL -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet"/>

  <!-- (NUEVO) Hoja de estilos del CDN para fuente "Patria" -->
  <link href="https://framework-gb.cdn.gob.mx/gm/v3/assets/styles/main.css" rel="stylesheet">

  <!-- anime.js (para el pulso y animaciones) -->
  <script src="https://unpkg.com/animejs@3.2.1/lib/anime.min.js"></script>

  <style>
    /* ... tus estilos originales ... */
    /* Mantén igual la sección <style> de tu archivo */
  </style>
</head>
<body>

  <!-- ... tu HTML original ... -->

  <script>
    // === CONFIG ===
    const ACCESS_TOKEN = 'pk.eyJ1IjoiY2hheXZvbHRhIiwiYSI6ImNsdGRlNml1NDAyaXgyanJ3eXYzdGQ0MmEifQ.VH5UyDCjvPQ1X_KrkkHcZQ';
    const BASE = '../';
    const STATE_GEO  = BASE + 'data/campeche.geojson';
    const POINTS_GEO = BASE + 'data/puntos_campeche.geojson';
    const ICON_URL   = BASE + 'img/eco.svg';

    let map, pointsData = null, stateBounds = null;
    let pulseAnim = null, activeId = null;
    let breathingAnim = null;

    mapboxgl.accessToken = ACCESS_TOKEN;
    map = new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/mapbox/satellite-streets-v12',
      center:[-90.5, 19.8],
      zoom:5, pitch:0, bearing:0, projection:'globe'
    });
    map.addControl(new mapboxgl.NavigationControl({ visualizePitch:true }), 'top-right');

    map.on('load', async () => {
      // -
      map.addSource('mapbox-dem', {
        "type": "raster-dem",
        "url": "mapbox://mapbox.terrain-rgb",
        "tileSize": 512,
        "maxzoom": 14
      });
      map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });

      // Estado
      const state = await fetch(STATE_GEO).then(r=>r.json());
      stateBounds = getGeoJSONBounds(state);
      map.addSource('campeche-poly',{ type:'geojson', data: state });
      map.addLayer({ id:'campeche-fill', type:'fill', source:'campeche-poly',
        paint:{ 'fill-color':'#EA5188', 'fill-opacity':0.18 }});
      map.addLayer({ id:'campeche-line', type:'line', source:'campeche-poly',
        paint:{ 'line-color':'#EA5188', 'line-width':2 }});

      // Puntos con CLUSTERING habilitado
      pointsData = await fetch(POINTS_GEO).then(r=>r.json());
      map.addSource('campeche-points', {
        type: 'geojson',
        data: pointsData,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      // Icono
      const img = new Image(32,32);
      img.src = ICON_URL;
      img.onload = () => {
        if (!map.hasImage('eco')) map.addImage('eco', img, { pixelRatio: 2 });
        addClusterLayers();
        setupClusterClick();
        setupPointClick();
        startBreathingAll();
      };

      if (stateBounds) { map.fitBounds(stateBounds, { padding: 40, duration: 800 }); }
    });

    // --- CLUSTERING LAYERS ---
    function addClusterLayers() {
      // Círculo para clusters
      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'campeche-points',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#F7E07F',
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            23,  // radio para 1-9 puntos agrupados
            10, 28,  // radio para 10-24 puntos agrupados
            25, 35   // radio para 25+ puntos agrupados
          ],
          'circle-stroke-width': 2,
          'circle-stroke-color': '#EA5188'
        }
      });
      // Número de puntos en el cluster
      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'campeche-points',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count'],
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 14
        },
        paint: {
          'text-color': '#EA5188'
        }
      });
      // Puntos individuales (no agrupados)
      map.addLayer({
        id: 'unclustered-point',
        type: 'symbol',
        source: 'campeche-points',
        filter: ['!', ['has', 'point_count']],
        layout: {
          'icon-image': 'eco',
          'icon-size': 3,
          'icon-allow-overlap': true
        }
      });
      // Icono activo para pulso extra
      if (!map.getLayer('campeche-symbols-active')) {
        map.addLayer({
          id: 'campeche-symbols-active',
          type: 'symbol',
          source: 'campeche-points',
          filter: ['all', ['!', ['has', 'point_count']], ['==', ['get','id'], '__none__']],
          layout: {
            'icon-image': 'eco',
            'icon-size': 4.2,
            'icon-allow-overlap': true
          }
        });
      }
      // Etiquetas
      if (!map.getLayer('campeche-labels')) {
        map.addLayer({
          id:'campeche-labels',
          type:'symbol',
          source:'campeche-points',
          filter: ['!', ['has', 'point_count']],
          layout:{
            'text-field': ['get','Name'],
            'text-size': 14,
            'text-offset': [0, 2.2],
            'text-anchor': 'top',
            'text-allow-overlap': true,
            'text-ignore-placement': true
          },
          paint:{
            'text-color':'#ffffff',
            'text-halo-color':'#000000',
            'text-halo-width': 1.5
          }
        });
      }
    }

    // --- Animaciones y lógica original ---
    function startBreathingAll() {
      if (breathingAnim) breathingAnim.pause();
      let state = { s: 3 };
      breathingAnim = anime({
        targets: state,
        s: [3, 3.7],
        duration: 1200,
        direction: 'alternate',
        easing: 'easeInOutSine',
        loop: true,
        update: () => {
          if (map.getLayer('unclustered-point')) {
            map.setLayoutProperty('unclustered-point', 'icon-size', state.s);
          }
        }
      });
    }

    function animateCardIn(card) {
      card.style.display = 'block';
      anime({
        targets: card,
        opacity: [0, 1],
        scale: [0.95, 1],
        duration: 600,
        easing: 'easeOutQuad'
      });
    }
    function animateCardOut(card) {
      anime({
        targets: card,
        opacity: [1, 0],
        scale: [1, 0.95],
        duration: 400,
        easing: 'easeInQuad',
        complete: function() {
          card.style.display = 'none';
        }
      });
    }

    function showSideCard(id) {
      document.querySelectorAll('#story-side .story-content').forEach(card => {
        if (card.classList.contains('active')) {
          card.classList.remove('active');
          animateCardOut(card);
        }
      });
      const card = document.getElementById('card-' + id);
      if (card) {
        card.classList.add('active');
        animateCardIn(card);
      }
      flyToFeatureId(id);
    }

    // --- CLICK: clusters y puntos individuales ---
    function setupClusterClick() {
      map.on('click', 'clusters', function(e) {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('campeche-points').getClusterExpansionZoom(clusterId, function (err, zoom) {
          if (err) return;
          map.easeTo({
            center: features[0].geometry.coordinates,
            zoom: zoom,
            duration: 900
          });
        });
      });
      // Cursor en clusters
      map.on('mouseenter', 'clusters', function () {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'clusters', function () {
        map.getCanvas().style.cursor = '';
      });
    }

    function setupPointClick() {
      map.on('click', 'unclustered-point', function(e) {
        if (!e.features || !e.features.length) return;
        const feature = e.features[0];
        const id = feature.properties.id;
        showSideCard(id);
        startPulseFor(id);
      });
      // Cursor en puntos individuales
      map.on('mouseenter', 'unclustered-point', function () {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'unclustered-point', function () {
        map.getCanvas().style.cursor = '';
      });
    }

    function stopPulse() {
      if (pulseAnim) { pulseAnim.pause(); pulseAnim = null; }
      activeId = null;
      if (map.getLayer('campeche-symbols-active')) {
        map.setFilter('campeche-symbols-active', ['all', ['!', ['has', 'point_count']], ['==', ['get','id'], '__none__']]);
      }
    }
    function startPulseFor(id) {
      if (!map.getLayer('campeche-symbols-active')) return;
      const targetId = String(id);
      if (activeId === targetId) return;

      activeId = targetId;
      map.setFilter('campeche-symbols-active', ['all', ['!', ['has', 'point_count']], ['==', ['get','id'], activeId]]);

      if (pulseAnim) pulseAnim.pause();
      const state = { s: 4.2 };
      pulseAnim = anime({
        targets: state,
        s: [4.2, 5.2],
        duration: 900,
        direction: 'alternate',
        easing: 'easeInOutSine',
        loop: true,
        update: () => map.setLayoutProperty('campeche-symbols-active', 'icon-size', state.s)
      });
    }

    function flyToFeatureId(id){
      if (!pointsData) return;
      const f = pointsData.features.find(fe => (fe.properties && String(fe.properties.id) === String(id)));
      if (!f) return;
      const coords = f.geometry.coordinates; // [lng,lat]
      map.flyTo({ center: coords, zoom: 14, pitch: 35, bearing: 0, duration: 1400, essential: true });
    }

    function getGeoJSONBounds(gj){
      const b = new mapboxgl.LngLatBounds();
      const eachCoord = (coords) => {
        if (typeof coords[0] === 'number') b.extend(coords);
        else coords.forEach(eachCoord);
      };
      if (gj.type === 'FeatureCollection') gj.features.forEach(ft => eachCoord(ft.geometry.coordinates));
      else if (gj.type === 'Feature') eachCoord(gj.geometry.coordinates);
      else if (gj.type === 'Polygon' || gj.type === 'MultiPolygon') eachCoord(gj.coordinates);
      return b;
    }

    // Botón "Volver al inicio"
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('volver-inicio-btn');
      btn.addEventListener('click', function() {
        document.querySelectorAll('#story-side .story-content').forEach(card => {
          if (card.classList.contains('active')) {
            card.classList.remove('active');
            animateCardOut(card);
          }
        });
        if (stateBounds) {
          map.fitBounds(stateBounds, { padding: 40, duration: 1200 });
        }
        stopPulse();
      });
    });
  </script>
</body>
</html>
